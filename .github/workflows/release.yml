name: Build and Release

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type (major, minor, patch)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - major
          - minor
          - patch

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run type checking
        run: npm run type-check

      - name: Run tests
        run: npm test

  build-and-release:
    name: Build and Release
    needs: quality-checks
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build Chrome extension
        run: |
          echo "Building Chrome extension..."
          npm run build:chrome
          echo "Chrome build completed"

      - name: Build Firefox extension
        run: |
          echo "Building Firefox extension..."
          npm run build:firefox
          echo "Firefox build completed"

      - name: Package extensions
        run: |
          echo "Packaging extensions..."
          npm run package
          echo "Packaging completed"

          # Get current version for temporary naming
          CURRENT_VERSION=$(node -p "require('./package.json').version")

          # Rename zip files with current version (semantic-release will handle final version)
          if [ -f "privatetab-chrome.zip" ]; then
            mv privatetab-chrome.zip "privatetab-chrome-v${CURRENT_VERSION}.zip"
            echo "Created privatetab-chrome-v${CURRENT_VERSION}.zip"
          fi
          if [ -f "privatetab-firefox.zip" ]; then
            mv privatetab-firefox.zip "privatetab-firefox-v${CURRENT_VERSION}.zip"
            echo "Created privatetab-firefox-v${CURRENT_VERSION}.zip"
          fi

      - name: Generate checksums
        run: |
          echo "Generating SHA256 checksums..."
          sha256sum privatetab-*.zip | tee checksums.txt

      - name: Semantic Release
        uses: codfish/semantic-release-action@v4
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          additional-packages: |
            @semantic-release/changelog
            @semantic-release/git
            @semantic-release/exec
            conventional-changelog-conventionalcommits

      - name: Rename artifacts with final version
        if: steps.semantic.outputs.new-release-published == 'true'
        run: |
          # Get the new version from semantic-release output
          NEW_VERSION="${{ steps.semantic.outputs.release-version }}"
          CURRENT_VERSION=$(ls privatetab-chrome-*.zip | grep -oP 'v\K[0-9]+\.[0-9]+\.[0-9]+')

          echo "Updating artifacts from v${CURRENT_VERSION} to v${NEW_VERSION}"

          # Rename zip files
          if [ -f "privatetab-chrome-v${CURRENT_VERSION}.zip" ]; then
            mv "privatetab-chrome-v${CURRENT_VERSION}.zip" "privatetab-chrome-v${NEW_VERSION}.zip"
            echo "‚úì Renamed Chrome extension to v${NEW_VERSION}"
          fi
          if [ -f "privatetab-firefox-v${CURRENT_VERSION}.zip" ]; then
            mv "privatetab-firefox-v${CURRENT_VERSION}.zip" "privatetab-firefox-v${NEW_VERSION}.zip"
            echo "‚úì Renamed Firefox extension to v${NEW_VERSION}"
          fi

          # Regenerate checksums
          sha256sum privatetab-*.zip | tee checksums.txt

          echo ""
          echo "üì¶ Final artifacts:"
          ls -lh privatetab-*.zip checksums.txt

      - name: Release Summary
        if: steps.semantic.outputs.new-release-published == 'true'
        run: |
          echo "üéâ New release published!"
          echo "Version: ${{ steps.semantic.outputs.release-version }}"
          echo "Major: ${{ steps.semantic.outputs.release-major }}"
          echo "Minor: ${{ steps.semantic.outputs.release-minor }}"
          echo "Patch: ${{ steps.semantic.outputs.release-patch }}"

      - name: No Release
        if: steps.semantic.outputs.new-release-published != 'true'
        run: |
          echo "‚ÑπÔ∏è No new release published"
          echo "No commits since last release that trigger a version bump"